<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Radar Paranormal v4.0</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin: 0; padding: 0; background: #000; color: #0f0; font-family: monospace; }
    #map { height: 100vh; width: 100vw; }
    #ui {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: rgba(0,20,0,0.9); padding: 15px; border: 1px solid #0f0;
      min-width: 220px; pointer-events: none;
    }
    .warn { color: #ff0; }
    .crit { color: #f00; font-weight: bold; }
  </style>
</head>
<body>

  <div id="ui">
    <div>SISTEMA: <span id="status">LISTO</span></div>
    <div>UBICACIÓN: <span id="prov">-</span></div>
    <div>DETECTADOS: <span id="count">0</span></div>
    <div id="msg" style="font-size: 10px; margin-top: 5px; color: #888;"></div>
  </div>
  <div id="map"></div>

  <script>
    var map = L.map('map').setView([37.38, -5.98], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    var markersLayer = L.layerGroup().addTo(map);

    const kWords = ["paranormal", "fantasma", "espíritu", "leyenda", "misterio", "maldito", "encantado", "aparición", "psicofonía", "diablo", "muerte", "tragedia"];

    async function checkWiki(name, prov) {
      // Búsqueda más permisiva en Wikipedia
      const url = `https://es.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(name + " " + prov)}&format=json&origin=*&srlimit=3`;
      try {
        const r = await fetch(url);
        const d = await r.json();
        if (!d.query.search.length) return false;
        
        const fullText = d.query.search.map(s => s.snippet.toLowerCase()).join(" ");
        return kWords.some(k => fullText.includes(k));
      } catch (e) { return false; }
    }

    async function escanear() {
      const status = document.getElementById('status');
      const msg = document.getElementById('msg');
      const countEl = document.getElementById('count');

      // Validación de Zoom
      if (map.getZoom() < 12) {
        status.innerText = "ZOOM MUY ALTO";
        msg.innerText = "Acércate más para activar el radar.";
        return;
      }

      status.innerText = "PROCESANDO...";
      status.className = "";
      msg.innerText = "Consultando registros geográficos...";

      const b = map.getBounds();
      const bbox = `${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}`;

      // Query simplificada para mayor velocidad
      const query = `[out:json][timeout:20];(
        node["name"~"Cortijo|Hacienda|Monasterio|Fábrica|Cementerio|Venta|Torre",i](${bbox});
        way["name"~"Cortijo|Hacienda|Monasterio|Fábrica|Cementerio|Torre",i](${bbox});
      );out center;`;

      try {
        const response = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query));
        if (!response.ok) throw new Error("API Ocupada");

        const data = await response.json();
        markersLayer.clearLayers();
        let encontrados = 0;

        msg.innerText = `Analizando ${data.elements.length} candidatos...`;

        for (let el of data.elements) {
          const nombre = el.tags.name;
          const lat = el.lat || el.center.lat;
          const lon = el.lon || el.center.lon;
          const prov = document.getElementById('prov').innerText;

          // Filtro: Si el nombre ya es "sospechoso" lo saltamos a validación directa
          const esSospechoso = kWords.some(k => nombre.toLowerCase().includes(k));
          const wikiValid = await checkWiki(nombre, prov);

          if (wikiValid || esSospechoso) {
            encontrados++;
            L.circleMarker([lat, lon], {
              radius: 12, fillColor: "#f00", color: "#fff", weight: 2, fillOpacity: 0.8
            }).addTo(markersLayer)
              .bindPopup(`<b>${nombre}</b><br><span style="color:red">REFERENCIA PARANORMAL HALLADA</span><br><br><a href="https://www.google.com/search?q=${encodeURIComponent(nombre + ' ' + prov + ' paranormal')}" target="_blank">Abrir Informe</a>`);
          }
        }
        countEl.innerText = encontrados;
        status.innerText = "RADAR ACTIVO";
        msg.innerText = encontrados > 0 ? "Objetos detectados." : "Sin actividad paranormal en esta zona.";
      } catch (err) {
        status.innerText = "ERROR DE CARGA";
        status.className = "crit";
        msg.innerText = "Servidor saturado. Espera 10 segundos.";
      }
    }

    // Geocodificación de provincia
    map.on('moveend', async () => {
      const c = map.getCenter();
      try {
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${c.lat}&lon=${c.lng}`);
        const d = await r.json();
        document.getElementById('prov').innerText = d.address.province || d.address.state || "Sevilla";
      } catch(e){}
      
      clearTimeout(window.t);
      window.t = setTimeout(escanear, 2000);
    });

    escanear();
  </script>
</body>
</html>
