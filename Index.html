<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Radar Paranormal Wikipedia</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin: 0; padding: 0; background: #050505; }
    #map { height: 100vh; width: 100vw; }
    #loader {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      z-index: 1000; background: rgba(255,0,0,0.9); color: white;
      padding: 10px 20px; font-family: monospace; border: 2px solid white;
      display: none; box-shadow: 0 0 20px red;
    }
  </style>
</head>
<body>

  <div id="loader">ESCANEANDO REGISTROS DE WIKIPEDIA...</div>
  <div id="map"></div>

  <script>
    var map = L.map('map').setView([37.38, -5.98], 12); // Sevilla/Carmona
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; Wikipedia Contributors'
    }).addTo(map);

    var markersLayer = L.layerGroup().addTo(map);

    async function buscarEnWikipedia() {
      document.getElementById('loader').style.display = 'block';
      markersLayer.clearLayers();

      const center = map.getCenter();
      // Wikipedia busca en un radio desde el centro del mapa (en metros)
      const radius = 10000; 
      
      // 1. Buscamos artículos cercanos con coordenadas
      const url = `https://es.wikipedia.org/w/api.php?action=query&list=geosearch&gsradius=${radius}&gscoord=${center.lat}|${center.lng}&format=json&origin=*&gslimit=50`;

      try {
        const response = await fetch(url);
        const data = await response.json();
        const locations = data.query.geosearch;

        for (let loc of locations) {
          // 2. Por cada lugar, pedimos un resumen para ver si es "interesante" (paranormal/histórico)
          const detailUrl = `https://es.wikipedia.org/w/api.php?action=query&prop=extracts|info&exintro&titles=${encodeURIComponent(loc.title)}&format=json&origin=*&inprop=url`;
          const detRes = await fetch(detailUrl);
          const detData = await detRes.json();
          const page = Object.values(detData.query.pages)[0];
          const text = page.extract ? page.extract.toLowerCase() : "";
          const fullUrl = page.fullurl;

          // Filtro de "Interés": ¿Contiene palabras clave?
          const keywords = ["leyenda", "misterio", "fantasma", "aparición", "monasterio", "crimen", "abandonado", "ruinas", "convento", "palacio"];
          const matches = keywords.some(word => text.includes(word));

          if (matches || loc.title.toLowerCase().includes("monasterio") || loc.title.toLowerCase().includes("diablo")) {
            // 3. Insertamos en el mapa
            const marker = L.circleMarker([loc.lat, loc.lon], {
              radius: 12,
              fillColor: "#ff0000",
              color: "#fff",
              weight: 2,
              fillOpacity: 0.8
            }).addTo(markersLayer);

            marker.bindPopup(`
              <div style="font-family:sans-serif;">
                <h3 style="margin:0">${loc.title}</h3>
                <p style="font-size:12px; color:#666;">Distancia: ${loc.dist}m</p>
                <p style="font-size:13px;">${text.substring(0, 150)}...</p>
                <a href="${fullUrl}" target="_blank" style="color:red; font-weight:bold;">Leer historia completa</a>
              </div>
            `);
          }
        }
      } catch (e) {
        console.error("Error cargando Wikipedia", e);
      } finally {
        document.getElementById('loader').style.display = 'none';
      }
    }

    // Escuchar cuando el usuario deja de mover el mapa
    map.on('moveend', buscarEnWikipedia);
    
    // Carga inicial
    buscarEnWikipedia();
  </script>
</body>
</html>
