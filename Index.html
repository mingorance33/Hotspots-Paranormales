<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mapa Paranormal - Agustín Bola Mortimer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Meta OG -->
    <meta property="og:title" content="Mapa de Investigación Paranormal">
    <meta property="og:description" content="Explora los puntos más paranormales detectados en mis investigaciones. Agustín Bola Mortimer.">
    <meta property="og:image" content="https://mapaparanormal.netlify.app/terrifie.jpg">
    <meta property="og:url" content="https://mapaparanormal.netlify.app/">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="es_ES">
    <meta name="twitter:card" content="summary_large_image">
    <meta property="og:seeAlso" content="https://www.tiktok.com/@agustinbolamortimer666">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        :root {
            --color-fondo: #050506;
            --color-texto: #f5f5f5;
            --color-rojo: #b10018;
            --color-youtube: #ff0000;
            --color-panel: rgba(5, 5, 6, 0.95);
            --color-borde: rgba(255, 255, 255, 0.15);
        }
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; height: 100%; background: var(--color-fondo); color: var(--color-texto); font-family: sans-serif; overflow: hidden; }
        #map { width: 100%; height: 100vh; z-index: 1; }

        /* Header */
        .header { position: fixed; top: 10px; left: 54px; display: flex; align-items: center; z-index: 1000; background: var(--color-panel); backdrop-filter: blur(8px); padding: 8px 14px; border-radius: 8px; border: 1px solid var(--color-borde); text-decoration: none; color: inherit; }
        .header-logo { width: 42px; height: 42px; border-radius: 50%; overflow: hidden; border: 1px solid var(--color-rojo); flex-shrink: 0; }
        .header-logo img { width: 100%; height: 100%; object-fit: cover; }
        .header-title { margin-left: 12px; font-size: 0.9rem; font-weight: bold; text-transform: uppercase; color: var(--color-rojo); }

        /* Popups */
        .leaflet-popup-content-wrapper { background: rgba(0,0,0,0.95); color: var(--color-texto); border: 1px solid var(--color-borde); padding: 0; overflow: hidden; border-radius: 8px; }
        .leaflet-popup-content { margin: 0; width: 280px !important; } /* Ampliado para relatos */
        .popup-img { width: 100%; height: 130px; object-fit: cover; border-bottom: 2px solid var(--color-rojo); display: block; }
        .popup-body { padding: 12px; }
        .popup-title { font-weight: bold; color: var(--color-rojo); text-transform: uppercase; display: block; font-size: 14px; margin-bottom: 5px; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 4px; margin: 8px 0; }
        .tag { font-size: 9px; padding: 3px 7px; border-radius: 4px; text-transform: uppercase; font-weight: bold; border: 1px solid rgba(255,255,255,0.1); }
        .tag-psicofonia { background: #1a4d8a; color: #fff; }
        .tag-aparicion { background: #b10018; color: #fff; }
        .tag-poltergeist { background: #8a6d1a; color: #fff; }
        .btn-popup { display: block; text-align: center; padding: 8px; text-decoration: none; font-weight: bold; font-size: 11px; border-radius: 4px; margin-top: 8px; }
        .btn-maps { background: #333; color: white; }
        .btn-youtube { background: var(--color-youtube); color: white; }

        /* UGC Comunidad */
        .ugc-panel { position: fixed; right: 20px; top: 70px; width: 320px; max-height: 60vh; background: var(--color-panel); border: 1px solid var(--color-borde); border-radius: 8px; z-index: 1000; display: none; flex-direction: column; backdrop-filter: blur(8px); }
        .ugc-panel.active { display: flex; }
        .ugc-header { padding: 12px; border-bottom: 1px solid var(--color-borde); font-weight: bold; color: var(--color-rojo); text-align: center; }
        .ugc-form { padding: 12px; }
        .ugc-textarea { width: 100%; height: 100px; background: rgba(0,0,0,0.5); color: var(--color-texto); border: 1px solid var(--color-borde); border-radius: 4px; padding: 8px; resize: vertical; font-family: monospace; }
        .ugc-charcount { font-size: 11px; color: #ccc; text-align: right; margin-top: 4px; }
        .ugc-submit { width: 100%; background: var(--color-rojo); color: white; border: none; padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 8px; }
        .ugc-list { flex: 1; overflow-y: auto; padding: 12px; }
        .ugc-item { background: rgba(255,255,255,0.05); border-radius: 4px; padding: 10px; margin-bottom: 8px; font-size: 12px; line-height: 1.4; }
        .ugc-author { color: var(--color-rojo); font-weight: bold; }
        .ugc-date { color: #ccc; font-size: 10px; }
        .ugc-votes { float: right; color: #ccc; font-size: 11px; }
        .popup-ugc { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--color-borde); max-height: 200px; overflow-y: auto; }
        .popup-ugc h4 { color: var(--color-rojo); font-size: 12px; margin: 0 0 8px 0; }
        .popup-ugc-item { font-size: 11px; margin-bottom: 6px; color: #ddd; }

        /* Buscador */
        .leaflet-control-search { background: var(--color-panel); border: 2px solid rgba(255,255,255,0.2); border-radius: 4px; display: flex; flex-direction: column; }
        .search-wrapper { display: flex; align-items: center; padding: 2px; }
        #search-input { width: 0; height: 30px; border: none; background: transparent; color: white; padding: 0; transition: width 0.3s; outline: none; }
        .leaflet-control-search:hover #search-input { width: 180px; padding: 0 10px; }
        .search-icon-btn { width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; color: var(--color-rojo); }
        #search-results { background: var(--color-panel); max-height: 200px; overflow-y: auto; width: 210px; display: none; border-top: 1px solid var(--color-borde); }
        .search-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid var(--color-borde); font-size: 0.85rem; }

        /* Footer contacto */
        .contact-footer { position: fixed; bottom: 20px; left: 20px; z-index: 1000; display: flex; align-items: center; background: var(--color-panel); padding: 10px 16px; border-radius: 30px; border: 1px solid var(--color-borde); text-decoration: none; color: var(--color-texto); backdrop-filter: blur(8px); }
        .footer-icon { width: 16px; fill: white; margin: 0 8px; vertical-align: middle; }
        .contact-label { font-size: 11px; margin-left: 5px; }

        /* Capas UI */
        .leaflet-control-layers { background: var(--color-panel) !important; color: white !important; border: 1px solid var(--color-borde) !important; }

        @media (max-width: 600px) {
            .contact-label { display: none; }
            .header { left: 50px; }
            .ugc-panel { right: 10px; width: 90vw; max-width: 400px; }
        }
    </style>
</head>
<body>
    <a href="https://www.youtube.com/@AgustinBolaMortimer" target="_blank" class="header">
        <div class="header-logo"><img src="terrifie.jpg" alt="Logo"></div>
        <div class="header-title" id="header-title-text">Mapa Paranormal</div>
    </a>

    <div id="map"></div>

    <!-- UGC Panel Comunidad -->
    <div class="ugc-panel" id="ugc-panel">
        <div class="ugc-header">¡Comparte tu Relato Paranormal! <br><small>Relatos detallados (>500 chars) ganan destaque</small></div>
        <div class="ugc-form">
            <textarea id="ugc-textarea" class="ugc-textarea" placeholder="Describe tu experiencia en detalle: sonidos, visiones, fechas... ¡Sé exhaustivo!"></textarea>
            <div class="ugc-charcount" id="ugc-charcount">0 / 10000</div>
            <input type="file" id="ugc-image" accept="image/*" style="display:none;">
            <button class="ugc-submit" onclick="submitUGC()">Compartir Relato</button>
        </div>
        <div class="ugc-list" id="ugc-list"></div>
    </div>

    <div class="contact-footer">
        <a href="mailto:tu-correo@ejemplo.com" style="color:var(--color-rojo); text-decoration:none; font-weight:bold;">Contacto</a>
        <a href="https://www.tiktok.com/@agustinbolamortimer666" target="_blank">
            <svg class="footer-icon" viewBox="0 0 448 512"><path d="M448 209.91a210.06 210.06 0 0 1-122.77-39.25V349.38A162.55 162.55 0 1 1 185 188.31V278.2a74.62 74.62 0 1 0 52.23 71.18V0l88 0a121.18 121.18 0 0 0 1.86 22.32c7.87 3.34 15.33 7.45 22.43 12.17a126.66 126.66 0 0 0 77.32 26.06V130c-14.27-.11-28.38-2.58-41.69-7.23a127.84 127.84 0 0 0-37.16-21.36V209.91z"/></svg>
        </a>
        <span class="contact-label" id="contact-label-text">Agustín Bola Mortimer</span>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // Internacionalización básica UI
        const userLang = (navigator.language || navigator.userLanguage).split('-')[0];
        const supportedLangs = ['es', 'en', 'vi'];
        const lang = supportedLangs.includes(userLang) ? userLang : 'es';
        const t = {
            es: {
                title: 'Mapa Paranormal',
                contactLabel: 'Agustín Bola Mortimer',
                searchPlaceholder: 'Buscar...',
                btnWatch: 'Ver investigación',
                btnDirections: 'Cómo llegar',
                ugcTitle: '¡Comparte tu Relato!',
                ugcSubmit: 'Compartir',
                ugcLong: '¡Relato largo! +1 Destaque'
            },
            en: { /* ... traducciones similares ... */ },
            vi: { /* ... */ }
        };

        function applyStaticTranslations() {
            const dict = t[lang] || t['es'];
            const titleEl = document.getElementById('header-title-text');
            if (titleEl) titleEl.textContent = dict.title;
            const contactLabelEl = document.getElementById('contact-label-text');
            if (contactLabelEl) contactLabelEl.textContent = dict.contactLabel;
            const searchInputEl = document.getElementById('search-input');
            if (searchInputEl) searchInputEl.placeholder = dict.searchPlaceholder;
        }

        // Mapa
        const map = L.map('map', { zoomControl: true }).setView([37.3, -5.9], 10);

        // Capas base
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
        const satelite = L.layerGroup(
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 }),
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png', { maxZoom: 19 })
        );
        const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17 });
        osm.addTo(map);
        const baseLayers = {
            'Mapa Normal': osm,
            'Satélite': satelite,
            'Relieve Topo': topo
        };
        L.control.layers(baseLayers, null, { position: 'topright' }).addTo(map);

        // Icono custom
        const paranormalIcon = L.divIcon({
            className: 'custom-div-icon',
            html: '<div style="background-color: var(--color-rojo); width:15px; height:15px; border-radius:50%; border:2px solid white; box-shadow:0 0 12px var(--color-rojo);"></div>',
            iconSize: [15, 15], iconAnchor: [7, 7], popupAnchor: [0, -10]
        });

        let allData = [];
        function cleanText(text) {
            return text ? text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '') : '';
        }

        function generarTags(descripcion) {
            if (!descripcion) return '';
            const text = cleanText(descripcion);
            let tagsHTML = '<div class="tag-container">';
            let found = false;
            const reglas = [
                { terminos: ['psicofonia', 'audio', 'voces'], clase: 'tag-psicofonia', label: 'Psicofonías' },
                { terminos: ['aparicion', 'sombra', 'espectro', 'figura'], clase: 'tag-aparicion', label: 'Apariciones' },
                { terminos: ['poltergeist', 'movimiento', 'golpes'], clase: 'tag-poltergeist', label: 'Poltergeist' }
                // Añade más reglas según tus tags
            ];
            reglas.forEach(r => {
                if (r.terminos.some(t => text.includes(t))) {
                    tagsHTML += `<span class="tag ${r.clase}">${r.label}</span>`;
                    found = true;
                }
            });
            tagsHTML += '</div>';
            return found ? tagsHTML : '';
        }

        // UGC Storage y Funciones
        function loadUGC() {
            return JSON.parse(localStorage.getItem('ugcRelatos') || '[]');
        }
        function saveUGC(ugc) {
            localStorage.setItem('ugcRelatos', JSON.stringify(ugc));
            renderUGCList();
        }
        function submitUGC() {
            const textarea = document.getElementById('ugc-textarea');
            const text = textarea.value.trim();
            const imageFile = document.getElementById('ugc-image').files[0];
            const latlng = map.getCenter(); // Usa centro actual o hotspot activo
            if (text.length < 200) {
                alert('¡Relato muy corto! Escribe al menos 200 caracteres para compartir.');
                return;
            }
            const ugc = {
                id: Date.now(),
                text: text,
                author: 'Usuario Anónimo', // Integra login si quieres
                date: new Date().toLocaleString('es-ES'),
                lat: latlng.lat,
                lng: latlng.lng,
                image: imageFile ? URL.createObjectURL(imageFile) : null,
                votes: 0,
                long: text.length > 500
            };
            const allUGC = loadUGC();
            allUGC.push(ugc);
            saveUGC(allUGC);
            textarea.value = '';
            document.getElementById('ugc-charcount').textContent = '0 / 10000';
            alert(ugc.long ? '¡Relato épico compartido! Ganó destaque.' : 'Relato compartido. ¡Añade más detalles para destaque!');
        }
        function renderUGCList(hotspotId = null) {
            const ugcList = document.getElementById('ugc-list');
            const allUGC = loadUGC();
            const filtered = hotspotId ? allUGC.filter(u => Math.abs(u.lat - hotspotId.lat) < 0.01 && Math.abs(u.lng - hotspotId.lng) < 0.01) : allUGC.slice(-10).reverse();
            ugcList.innerHTML = filtered.map(u => `
                <div class="ugc-item">
                    <div class="ugc-author">${u.author} <span class="ugc-date">${u.date}</span> <span class="ugc-votes">⭐ ${u.votes}</span></div>
                    ${u.image ? `<img src="${u.image}" style="width:100%; height:60px; object-fit:cover; border-radius:4px; margin:4px 0;">` : ''}
                    <div>${u.text.substring(0, 200)}${u.text.length > 200 ? '...' : ''}</div>
                    ${u.long ? '<small style="color:gold;">Relato Destacado</small>' : ''}
                </div>
            `).join('');
        }
        function getUGCForPopup(hotspot) {
            const allUGC = loadUGC();
            const relevant = allUGC.filter(u => Math.abs(u.lat - hotspot.lat) < 0.01 && Math.abs(u.lng - hotspot.lng) < 0.01).slice(0, 3);
            if (relevant.length === 0) return '';
            return `
                <div class="popup-ugc">
                    <h4>Relatos Comunidad</h4>
                    ${relevant.map(u => `<div class="popup-ugc-item">${u.text.substring(0, 100)}... <small>${u.author}</small><
